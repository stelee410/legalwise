# 聊天窗口怎么上传图片和文件

本文档基于 `linkyun-agent-ui/client-user-hub/lumina-ai-chat-hub` 源码分析，说明聊天窗口中图片和附件上传的完整逻辑，包括代码实现和调用的 Service。

---

## 一、整体流程概览

```
用户选择文件 → 弹窗确认 → 生成 PendingAttachment（含 _file）→ 点击发送
    → resolvePendingAttachments 上传文件 → 获得 token
    → sendUserMessage / sendGroupMessage 携带 attachments
    → 消息展示（MessageAttachments）
```

**核心策略**：选择文件后先不立刻上传，而是保存为 `PendingAttachment`（含 `_file`），在用户点击「发送」时再统一上传并获取 `token`，然后随消息一起发送。

---

## 二、能力开关（Agent 是否支持上传）

上传按钮是否显示，取决于当前聊天对应的 Agent 是否配置了相应技能：

| 能力 | 字段 | 说明 |
|------|------|------|
| 图片上传 | `supports_image_upload` | Agent 配置了 `image_upload` 技能 |
| 文档上传 | `supports_document_upload` | Agent 配置了 `document_upload` 技能 |

来源：

- **1v1 聊天**：`UserChatSession.supports_image_upload` / `supports_document_upload`
- **群聊**：`GroupParticipant.supports_image_upload` / `supports_document_upload`，任一参与者支持即显示

在 `App.tsx` 中传给 `ChatWindow`：

```tsx
supportsImageUpload={activeChat.supports_image_upload}
supportsDocumentUpload={activeChat.supports_document_upload}
```

---

## 三、组件与职责

### 3.1 ChatWindow（主容器）

**文件**：`components/ChatWindow.tsx`

**职责**：

- 管理 `pendingImage`、`pendingDocument` 状态
- 渲染 `ImageUploadButton`、`DocumentUploadButton`
- 发送时把 `pendingImage`、`pendingDocument` 作为 `pendingAttachments` 传给 `onSendMessage`

**关键代码**：

```tsx
const [pendingImage, setPendingImage] = useState<(PendingAttachment & { url?: string; _file?: File }) | null>(null);
const [pendingDocument, setPendingDocument] = useState<(PendingAttachment & { _file?: File }) | null>(null);

// 发送时
const pending: PendingAttachment[] = [];
if (pendingImage) pending.push(pendingImage);
if (pendingDocument) pending.push(pendingDocument);
onSendMessage(text, targetAgentIds, pending.length > 0 ? pending : undefined);
```

### 3.2 ImageUploadButton

**文件**：`components/ImageUploadButton.tsx`

**职责**：

- 展示图片上传入口（图标或已选图片缩略图）
- 打开 `ImageUploadModal` 选择图片
- 通过 `onUploaded` 把选中的 `PendingImageAttachment` 回传给 `ChatWindow`

**缩略图来源**：

- `blob:` 或 `http`：直接使用 `att.url`
- 已有 `token`：`/api/v1/files/${token}/download?preview=1`

### 3.3 DocumentUploadButton

**文件**：`components/DocumentUploadButton.tsx`

**职责**：

- 展示文档上传入口
- 打开 `DocumentUploadModal` 选择文档
- 支持 `onClear` 清除已选文档

### 3.4 ImageUploadModal

**文件**：`components/ImageUploadModal.tsx`

**职责**：

- 点击或拖拽选择图片
- 校验：`file.type.startsWith("image/")`，大小 ≤ 20MB
- 确认后构造 `PendingImageAttachment` 并回调

**输出结构**：

```ts
{
  type: "image",
  url: URL.createObjectURL(selectedFile),  // blob 预览
  mime_type: string,
  name: string,
  size: number,
  _file: File  // 原始文件，发送时上传
}
```

### 3.5 DocumentUploadModal

**文件**：`components/DocumentUploadModal.tsx`

**职责**：

- 点击或拖拽选择文档
- 校验：扩展名 `.pdf`、`.doc`、`.docx`、`.txt`，大小 ≤ 20MB
- 确认后构造 `PendingDocumentAttachment` 并回调

**输出结构**：

```ts
{
  type: "file",
  mime_type: string,
  name: string,
  size: number,
  _file: File
}
```

### 3.6 MessageAttachments

**文件**：`components/MessageAttachments.tsx`

**职责**：在消息气泡中展示附件（预览、下载链接、文件名、大小）。

---

## 四、Service 层（api.ts）

### 4.1 上传接口

#### 图片上传：`uploadImageFile`

```ts
POST /api/v1/files/upload
Content-Type: multipart/form-data
X-API-Key: <apiKey>
Body: FormData { file: File }
```

**校验**：

- `file.type.startsWith("image/")`
- 大小 ≤ 20MB

**返回**：

```ts
{
  token: string;
  download_url: string;
  preview_url: string;
  expires_in: number;
}
```

#### 文档上传：`uploadDocumentFile`

```ts
POST /api/v1/files/upload-document
Content-Type: multipart/form-data
X-API-Key: <apiKey>
Body: FormData { file: File }
```

**校验**：

- 扩展名：`.pdf`、`.doc`、`.docx`、`.txt`
- 大小 ≤ 20MB

**返回**：

```ts
{
  token: string;
  download_url: string;
  expires_in: number;
}
```

### 4.2 发送前解析：`resolvePendingAttachments`

**作用**：在发送消息前，把带 `_file` 的 `PendingAttachment` 转为带 `token` 的 `ResolvedAttachment`。

**逻辑**：

1. 若有 `_file`：按 `type` 和 `isDocumentFile(_file)` 选择 `uploadImageFile` 或 `uploadDocumentFile` 上传
2. 若已有 `token`：直接透传
3. 返回 `ResolvedAttachment[]`，包含 `type`、`token`、`download_url`、`preview_url` 等

**调用位置**：`App.tsx` 的 `sendMessage` 中，在调用 `sendUserMessage` / `sendGroupMessage` 之前。

### 4.3 发送消息接口

#### 1v1：`sendUserMessage`

```ts
POST /api/v1/user/chats/{chatId}/messages
Body: {
  content: string;
  attachments?: { type: string; token: string }[];
}
```

#### 群聊：`sendGroupMessage`

```ts
POST /api/v1/user/group-chats/{chatId}/messages
Body: {
  content: string;
  target_agent_ids?: number[];
  attachments?: { type: string; token: string }[];
}
```

---

## 五、数据流详解

### 5.1 选择文件阶段

1. 用户点击图片/文档按钮 → 打开对应 Modal
2. 用户选择文件（点击或拖拽）→ Modal 校验类型和大小
3. 用户点击「确定」→ Modal 构造 `PendingAttachment`（含 `_file`）→ `onUploaded(att)`
4. `ChatWindow` 更新 `pendingImage` / `pendingDocument`，输入框上方显示预览

### 5.2 发送阶段（App.tsx sendMessage）

```ts
// 1. 解析待上传附件（上传文件，获得 token）
let attachments = [];
if (pendingAttachments?.length) {
  attachments = await resolvePendingAttachments(auth.apiKey, pendingAttachments);
}

// 2. 乐观更新：先插入用户消息（含 attachments）
const userMsg = {
  ...
  attachments: attachments.map((a) => ({ type: a.type, token: a.token, url: a.download_url })),
};
setChatMessages(...);

// 3. 调用 API 发送
const attachForApi = attachments.map((a) => ({ type: a.type, token: a.token }));
sendUserMessage(apiKey, chatId, text, attachForApi);
// 或
sendGroupMessage(apiKey, gId, text, targetAgentIds, attachForApi);
```

### 5.3 消息展示

- 文本：`ReactMarkdown` 渲染
- 附件：`MessageAttachments` 根据 `type` 区分图片和文档，生成预览/下载链接

**预览 URL**：`/api/v1/files/{token}/download?preview=1`  
**下载 URL**：`/api/v1/files/{token}/download`

---

## 六、类型定义

### PendingAttachment（待上传）

```ts
interface PendingAttachment {
  type: "image" | "file";
  url?: string;
  mime_type?: string;
  name?: string;
  size?: number;
  _file?: File;  // 发送时上传
  [key: string]: unknown;
}
```

### ResolvedAttachment（已上传）

```ts
interface ResolvedAttachment {
  type: string;
  token: string;
  download_url?: string;
  preview_url?: string;
  mime_type?: string;
  name?: string;
  size?: number;
}
```

### MessageAttachment（消息中的附件）

```ts
interface MessageAttachment {
  type: string;
  token?: string;
  url?: string;
  download_url?: string;
  preview_url?: string;
  name?: string;
  size?: number;
  mime_type?: string;
}
```

---

## 七、限制与校验汇总

| 项目 | 图片 | 文档 |
|------|------|------|
| 最大体积 | 20MB | 20MB |
| 类型 | `image/*` | `.pdf`, `.doc`, `.docx`, `.txt` |
| 校验位置 | ImageUploadModal + api.uploadImageFile | DocumentUploadModal + api.uploadDocumentFile |

---

## 八、文件清单

| 文件 | 作用 |
|------|------|
| `components/ChatWindow.tsx` | 聊天主窗口，管理 pending 状态和发送 |
| `components/ImageUploadButton.tsx` | 图片上传入口 |
| `components/DocumentUploadButton.tsx` | 文档上传入口 |
| `components/ImageUploadModal.tsx` | 图片选择弹窗 |
| `components/DocumentUploadModal.tsx` | 文档选择弹窗 |
| `components/MessageAttachments.tsx` | 消息中附件展示 |
| `services/api.ts` | uploadImageFile、uploadDocumentFile、resolvePendingAttachments、sendUserMessage、sendGroupMessage |
| `App.tsx` | 调用 sendMessage，内部使用 resolvePendingAttachments 和发送 API |

---

## 九、后端 API 依赖

聊天附件功能依赖以下后端接口：

1. `POST /api/v1/files/upload` — 图片上传
2. `POST /api/v1/files/upload-document` — 文档上传
3. `GET /api/v1/files/{token}/download` — 附件下载（支持 `?preview=1` 预览）
4. `POST /api/v1/user/chats/{chatId}/messages` — 1v1 发送消息（支持 attachments）
5. `POST /api/v1/user/group-chats/{chatId}/messages` — 群聊发送消息（支持 attachments）

后端需在 Agent 配置中启用 `image_upload`、`document_upload` 技能，会话接口才会返回 `supports_image_upload`、`supports_document_upload`，前端据此显示上传按钮。
